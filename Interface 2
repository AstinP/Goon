import easygui
import sqlite3
import os

# Create or connect to SQLite database using your table structure
def setup_database():
    conn = sqlite3.connect('Movies.db')
    cursor = conn.cursor()
    
    # Create MovieDB table matching your design
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS MovieDB (
            ID INTEGER PRIMARY KEY AUTOINCREMENT,
            Movie_Name TEXT NOT NULL,
            Release_Date INTEGER,
            Age_Rating TEXT,
            Duration INTEGER,
            Genre TEXT
        )
    ''')
    
    # Check if we need to import from films.txt
    cursor.execute("SELECT COUNT(*) FROM MovieDB")
    count = cursor.fetchone()[0]
    
    if count == 0 and os.path.exists('films.txt'):
        # Import movies from films.txt
        try:
            with open('films.txt', 'r') as file:
                movies_imported = 0
                for line in file:
                    data = line.strip().split(',')
                    if len(data) == 6:
                        # Skip the Movie_ID from films.txt since we use AUTOINCREMENT
                        cursor.execute('''
                            INSERT INTO MovieDB (Movie_Name, Release_Date, Age_Rating, Duration, Genre) 
                            VALUES (?, ?, ?, ?, ?)
                        ''', (data[1], int(data[2]), data[3], int(data[4]), data[5]))
                        movies_imported += 1
                if movies_imported > 0:
                    print(f"âœ… Imported {movies_imported} movies from films.txt into MovieDB table")
        except Exception as e:
            print(f"âš ï¸ Could not import from films.txt: {e}")
    
    conn.commit()
    conn.close()
    
    # Verify the database file was created
    if os.path.exists('Movies.db'):
        print("âœ… Database file 'Movies.db' created successfully with the 'MovieDB' table")
    else:
        print("âŒ Database file was not created")

# Add New Movie to database using MovieDB table
def add_new_movie():
    movie_name = easygui.enterbox("Enter movie title:", "âœ¨ Add New Movie")
    if movie_name:
        release_date = easygui.integerbox("Enter release year:", "âœ¨ Add New Movie", lowerbound=1900, upperbound=2030)
        if release_date:
            age_rating = easygui.choicebox("Select age rating:", "âœ¨ Add New Movie", 
                                         choices=["G", "PG", "PG-13", "R", "NC-17", "18+"])
            if age_rating:
                duration = easygui.integerbox("Enter duration (minutes):", "âœ¨ Add New Movie", lowerbound=1, upperbound=300)
                if duration:
                    genre = easygui.choicebox("Select genre:", "âœ¨ Add New Movie",
                                            choices=["Action", "Comedy", "Drama", "Crime", "Sci-Fi", "Horror", "Romance", "Adventure"])
                    if genre:
                        conn = sqlite3.connect('Movies.db')
                        cursor = conn.cursor()
                        cursor.execute('INSERT INTO MovieDB (Movie_Name, Release_Date, Age_Rating, Duration, Genre) VALUES (?, ?, ?, ?, ?)',
                                     (movie_name, release_date, age_rating, duration, genre))
                        conn.commit()
                        conn.close()
                        easygui.msgbox(f"âœ… Movie '{movie_name}' added successfully!", "âœ¨ Add New Movie")

# View All Movies from MovieDB table
def view_all_movies():
    conn = sqlite3.connect('Movies.db')
    cursor = conn.cursor()
    
    cursor.execute("SELECT * FROM MovieDB")
    movies = cursor.fetchall()
    conn.close()
    
    if not movies:
        easygui.msgbox("No movies found in the database.", "ğŸï¸ View All Movies")
        return
    
    movie_list = "ğŸ¬ YOUR MOVIE COLLECTION ğŸ¬\n"
    movie_list += "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
    movie_list += f"           ALL MOVIES ({len(movies)})\n"
    movie_list += "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
    
    for movie in movies:
        movie_list += f"â–¸ {movie[1]} ({movie[2]}) - {movie[5]} - {movie[4]}min - Rated: {movie[3]}\n"
    
    movie_list += f"\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    movie_list += f"Total movies: {len(movies)}\n"
    
    easygui.msgbox(movie_list, "ğŸï¸ View All Movies")

# Search Movies in MovieDB table
def search_movies():
    search_term = easygui.enterbox("Enter movie title to search:", "ğŸ” Search Movies")
    if search_term:
        conn = sqlite3.connect('Movies.db')
        cursor = conn.cursor()
        
        cursor.execute("SELECT * FROM MovieDB WHERE Movie_Name LIKE ?", (f'%{search_term}%',))
        results = cursor.fetchall()
        conn.close()
        
        if not results:
            message = f"""ğŸ” SEARCH RESULTS: '{search_term}'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        NO MOVIES FOUND
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

No movies found matching: '{search_term}'
Try a different search term."""
        else:
            message = f"""ğŸ” SEARCH RESULTS: '{search_term}'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       FOUND {len(results)} MOVIES
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"""
            
            for movie in results:
                message += f"â–¸ {movie[1]} ({movie[2]}) - {movie[5]} - {movie[4]}min - Rated: {movie[3]}\n"
            
            message += f"\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
            message += f"Found {len(results)} matches for '{search_term}'"
        
        easygui.msgbox(message, "ğŸ” Search Results")

# Verify database and table structure
def verify_database():
    """Check if the database and table are properly set up"""
    if not os.path.exists('Movies.db'):
        print("âŒ Movies.db file does not exist")
        return False
    
    conn = sqlite3.connect('Movies.db')
    cursor = conn.cursor()
    
    # Check if MovieDB table exists
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='MovieDB'")
    table_exists = cursor.fetchone()
    
    if table_exists:
        # Check table structure
        cursor.execute("PRAGMA table_info(MovieDB)")
        columns = cursor.fetchall()
        print("âœ… Table 'MovieDB' exists with columns:")
        for col in columns:
            print(f"   - {col[1]} ({col[2]})")
    else:
        print("âŒ Table 'MovieDB' does not exist")
    
    # Count movies
    cursor.execute("SELECT COUNT(*) FROM MovieDB")
    count = cursor.fetchone()[0]
    print(f"ğŸ“Š Total movies in database: {count}")
    
    conn.close()
    return table_exists is not None

# Main program
print("ğŸš€ Starting Movie Database Pro...")
setup_database()
verify_database()

title = "ğŸ¬ Movie Database Pro"
msg = """â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    MOVIE DATABASE MANAGER
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Please select an option:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"""

choices = ["ğŸ“¥ Add New Movie", "ğŸ“‹ View All Movies", 
           "ğŸ” Search Movies", "ğŸšª Exit"]

image = "Logo.png"

while True:
    choice = easygui.buttonbox(msg, title, image=image, choices=choices)

    if choice == "ğŸ“¥ Add New Movie":
        add_new_movie()
        
    elif choice == "ğŸ“‹ View All Movies":
        view_all_movies()
        
    elif choice == "ğŸ” Search Movies":
        search_movies()
        
    elif choice == "ğŸšª Exit":
        easygui.msgbox("""â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸŒŸ Thank You! ğŸŒŸ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Thank you for using Movie Database Pro!
Goodbye! ğŸ‘‹""", "Exit Program")
        break